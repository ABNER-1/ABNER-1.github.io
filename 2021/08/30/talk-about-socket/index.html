<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="A space where I put my study\read\work data"><title>浅谈 socket | Abner's Blog</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=1.0.0"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/normalize.css/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/purecss/build/pure-min.min.css"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/purecss/build/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><script type="text/javascript" src="//cdn.jsdelivr.net/npm/clipboard/dist/clipboard.min.js"></script><script type="text/javascript" src="//cdn.jsdelivr.net/gh/codeseven/toastr/build/toastr.min.js"></script><link rel="stylesheet" href="//cdn.jsdelivr.net/gh/codeseven/toastr/build/toastr.min.css"><meta name="generator" content="Hexo 4.2.1"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">浅谈 socket</h1><a id="logo" href="/.">Abner's Blog</a><p class="description">Welcome!</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">浅谈 socket</h1><div class="post-meta">2021-08-30<span> | </span><span class="category"><a href="/categories/network/">network</a><a href="/categories/network/operation-system/">operation system</a></span></div><div class="post-content"><p>最近在写 MIT 6.824 的 lab，其中读作业框架代码的时候发现当中 RPC 使用的是 Unix Socket，然后另一个被注释的实现是 TCP socket。就联想起 IPC 中的 Socket 方式。那么这三者究竟是怎样的关系呢？</p>
<a id="more"></a>
<p>[TOC]</p>
<h2 id="Socket-通信"><a href="#Socket-通信" class="headerlink" title="Socket 通信"></a>Socket 通信</h2><p>之前写过很原始的 TCP/UDP 通信，记得当时的代码大概是这个样子的:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//  create a socket</span></span><br><span class="line"><span class="keyword">if</span>( (listenfd = socket(AF_INET, SOCK_STREAM, <span class="number">0</span>)) == <span class="number">-1</span> )&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"create socket error: %s(errno: %d)\n"</span>,strerror(errno),errno);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// bind socket to a listen addr</span></span><br><span class="line"><span class="keyword">if</span>( bind(listenfd, (struct sockaddr*)&amp;servaddr, <span class="keyword">sizeof</span>(servaddr)) == <span class="number">-1</span>)&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"bind socket error: %s(errno: %d)\n"</span>,strerror(errno),errno);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// begin to listen</span></span><br><span class="line"><span class="keyword">if</span>( listen(listenfd, <span class="number">10</span>) == <span class="number">-1</span>)&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"listen socket error: %s(errno: %d)\n"</span>,strerror(errno),errno);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// accept a connection and handle</span></span><br><span class="line"><span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line"><span class="keyword">if</span>( (connfd = accept(listenfd, (struct sockaddr*)<span class="literal">NULL</span>, <span class="literal">NULL</span>)) == <span class="number">-1</span>)&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"accept socket error: %s(errno: %d)"</span>,strerror(errno),errno);</span><br><span class="line">    <span class="keyword">continue</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li>首先创建一个 Socket, 其中 SOCK_STREAM 制定 socket 是一个 TCP socket。</li>
<li>绑定一个地址</li>
<li>开始监听地址</li>
<li>accept 一个请求并处理</li>
</ol>
<p>这是一个比较清晰的样例，其调用的是 linux 关于 socket 的系统调用。</p>
<h2 id="Unix-Socket"><a href="#Unix-Socket" class="headerlink" title="Unix Socket"></a>Unix Socket</h2><p>在做 MIT 6.824 时发现本地 RPC 走的是 Unix Sokcet，而不是原本我印象中的用于网络通信的 Socket。其代码大致如下</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">l, e := net.Listen(<span class="string">"unix"</span>, sockname)</span><br><span class="line"><span class="keyword">if</span> e != <span class="literal">nil</span> &#123;</span><br><span class="line">    log.Fatal(<span class="string">"listen error:"</span>, e)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其通过一个 Socket 文件进行通信，会在 文件系统对应位置生成一个 <code>.sock</code> 文件。是不是很熟悉? 被 docker 折磨过的大概都记得 <code>/var/run/docker.sock</code> 文件吧，docker client 和 docker server 之间的通信方式就是通过 unix socket 协议。Unix socket 是一种很强大的 IPC 通信方式。</p>
<p>其系统调用过程如下：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">if</span> ((listenfd = socket(AF_UNIX, SOCK_STREAM, <span class="number">0</span>)) &lt; <span class="number">0</span>) &#123;  </span><br><span class="line">    perror(<span class="string">"socket error"</span>);  </span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>和 TCP 的过程几乎一摸一样，区别在于 AF_UNIX。<br>那么 socket 和 unix socket 究竟有什么关系呢，或者说两者是不是一种东西？</p>
<h3 id="tcp-socket-和-unix-socket-的比较"><a href="#tcp-socket-和-unix-socket-的比较" class="headerlink" title="tcp socket 和 unix socket 的比较"></a>tcp socket 和 unix socket 的比较</h3><p><a href="https://www.cnblogs.com/sparkdev/p/8359028.html" target="_blank" rel="noopener">博客的解释</a>：Unix domain socket 又叫 IPC(inter-process communication 进程间通信) socket，用于实现同一主机上的进程间通信。socket 原本是为网络通讯设计的，但后来在 socket 的框架上发展出一种 IPC 机制，就是 UNIX domain socket。虽然网络 socket 也可用于同一台主机的进程间通讯(通过 loopback 地址 127.0.0.1)，但是 UNIX domain socket 用于 IPC 更有效率：不需要经过网络协议栈，不需要打包拆包、计算校验和、维护序号和应答等，只是将应用层数据从一个进程拷贝到另一个进程。这是因为，IPC 机制本质上是可靠的通讯，而网络协议是为不可靠的通讯设计的。</p>
<p><a href="https://zhuanlan.zhihu.com/p/234806787" target="_blank" rel="noopener">知乎专栏</a>则将其统一为一体：根据通信域的不同可以划分成2种：Unix domain socket 和 Internet domain socket。</p>
<p><a href="https://serverfault.com/questions/124517/what-is-the-difference-between-unix-sockets-and-tcp-ip-sockets" target="_blank" rel="noopener">stack over flow</a>: 则从权限控制层次作为分析，Unix domain socket 没有经历网络，其更像是文件句柄，依赖文件系统的权限控制；而 TCP/UDP socket 则是网络层的概念，其经历网络的一系列操作后从报文层次（地址、端口等等）进行过滤</p>
<pre><code>raw answer：
A UNIX socket, AKA Unix Domain Socket, is an inter-process communication mechanism that allows bidirectional data exchange between processes running on the same machine.

IP sockets (especially TCP/IP sockets) are a mechanism allowing communication between processes over the network. In some cases, you can use TCP/IP sockets to talk with processes running on the same computer (by using the loopback interface).

UNIX domain sockets know that they’re executing on the same system, so they can avoid some checks and operations (like routing); which makes them faster and lighter than IP sockets. So if you plan to communicate with processes on the same host, this is a better option than IP sockets.

Edit: As per Nils Toedtmann&apos;s comment: UNIX domain sockets are subject to file system permissions, while TCP sockets can be controlled only on the packet filter level.</code></pre><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>总结一下：</p>
<ol>
<li>我更倾向于知乎的一个回答，将 TCP socket 和 Unix scoket 结合在一起称作 socket，因为其系统调用 type 的区别而不同。即 socket 分为两种：Internet domain socket 和 Unix domain socket</li>
<li>unix domain socket 层次更低一些，不涉及具体的网络操作，更像是文件句柄，受文件系统权限控制，也不包含网络解包等操作，所以在本地性能会更好一些。</li>
<li>unix domain socket 不能进行跨主机通信，只能算是 IPC。</li>
</ol>
</div><div class="tags"><a href="/tags/IPC/"><i class="fa fa-tag"></i>IPC</a></div><div class="post-nav"><a class="next" href="/2021/03/14/cpp-compile/">一个很奇怪的 c++ 项目编译问题</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="https://abner1997.gitee.io"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/network/">network</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/network/operation-system/">operation system</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">学习笔记</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/python/">python</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%AC%94%E8%AE%B0/">笔记</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/">读书笔记</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%B8%A9%E5%9D%91%E4%B9%8B%E8%B7%AF/">踩坑之路</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E9%9A%8F%E6%84%9F/">随感</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/git/" style="font-size: 15px;">git</a> <a href="/tags/shell/" style="font-size: 15px;">shell</a> <a href="/tags/go/" style="font-size: 15px;">go</a> <a href="/tags/grpc/" style="font-size: 15px;">grpc</a> <a href="/tags/https/" style="font-size: 15px;">https</a> <a href="/tags/k8s/" style="font-size: 15px;">k8s</a> <a href="/tags/AI/" style="font-size: 15px;">AI</a> <a href="/tags/%E7%BB%8F%E6%B5%8E%E5%AD%A6/" style="font-size: 15px;">经济学</a> <a href="/tags/opentracing/" style="font-size: 15px;">opentracing</a> <a href="/tags/%E8%AF%BB%E4%B9%A6/" style="font-size: 15px;">读书</a> <a href="/tags/CKAD-%E5%87%86%E5%A4%87/" style="font-size: 15px;">CKAD 准备</a> <a href="/tags/tensorflow/" style="font-size: 15px;">tensorflow</a> <a href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" style="font-size: 15px;">设计模式</a> <a href="/tags/%E5%8A%A8%E6%80%81%E8%AF%AD%E8%A8%80/" style="font-size: 15px;">动态语言</a> <a href="/tags/IPC/" style="font-size: 15px;">IPC</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2021/08/30/talk-about-socket/">浅谈 socket</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/03/14/cpp-compile/">一个很奇怪的 c++ 项目编译问题</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/03/14/review-phantoscope/">review phantoscope</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/03/10/k8s_mysql/">k8s 部署 mysql5.7 踩坑</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/03/06/extract_substring_in_shell/">如何在 shell 中根据正则提取子串</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/02/05/a-trick-in-absible/">a trick in absible</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/01/13/k8s-imgae-from-private-repo/">k8s 配置从私有仓库拉取镜像</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/01/05/fastAPI-debug-async/">fastAPI 异步机制调试实践</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/12/27/https%E7%9A%84%E4%B8%80%E6%AC%A1%E5%AE%9E%E8%B7%B5/">https 支持的一次实践</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/12/09/go-slice/">go slice</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://www.example1.com/" title="site-name1" target="_blank">site-name1</a><ul></ul><a href="http://www.example2.com/" title="site-name2" target="_blank">site-name2</a><ul></ul><a href="http://www.example3.com/" title="site-name3" target="_blank">site-name3</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2021 <a href="/." rel="nofollow">Abner's Blog.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=1.0.0" async></script><script type="text/javascript" src="//cdn.jsdelivr.net/gh/fancyapps/fancybox/dist/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=1.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox/dist/jquery.fancybox.min.css"><script type="text/javascript" src="/js/copycode.js" successtext="复制成功!"></script><link rel="stylesheet" type="text/css" href="/css/copycode.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=1.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=1.0.0"></script></div></body></html>