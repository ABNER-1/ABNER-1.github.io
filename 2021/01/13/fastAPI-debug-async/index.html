<!DOCTYPE html>
<html lang="en">
  <!-- Head tag -->
  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <!-- Title -->
  
  <title>fastAPI_debug_async - Abner&#39;s Blog</title>

  <!--Favicon-->
  <link rel="icon" href="favicon/favicon.ico">

  <!--Description-->
  
      <meta name="description" content="A space where I put my study\read\work data">
  

  <!--Author-->
  
      <meta name="author" content="Abner">
  

  <!-- Pure CSS -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/css/bootstrap.min.css" integrity="sha384-rwoIResjU2yc3z8GV/NPeZWAv56rSmLldC3R/AZzGRnGxQQKnKkoFVhFQhNUwEyJ" crossorigin="anonymous">
  <link href="https://fonts.googleapis.com/css?family=Crimson+Text|Open+Sans:300,800" rel="stylesheet">

  <!-- Custom CSS -->
  
<link rel="stylesheet" href="/css/styles.css">


  <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
  <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
  <![endif]-->

  <!-- Google Analytics -->
  

<meta name="generator" content="Hexo 4.2.1"></head>


  <body>
  	<div class="container-fluid navbar-container m-sm-5">
      <!-- Header -->
      <nav class="navbar navbar-toggleable-sm navbar-light px-1 py-3 my-3 mb-sm-5">
  <a class="navbar-brand ml-2" href="/">Abner's Blog</a>
  <button class="navbar-toggler navbar-toggler-right py-2" type="button" data-toggle="collapse" data-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>
  <div class="collapse navbar-collapse text-center" id="navbarCollapse">
    <ul class="navbar-nav ml-auto my-auto">
      
        <li class="nav-item">
          <a class="nav-link" href="/about">About</a>
        </li>
      
        <li class="nav-item">
          <a class="nav-link" href="/contact">Contact</a>
        </li>
      
        <li class="nav-item">
          <a class="nav-link" href="https://gitee.com/abner1997" target="_blank" rel="noopener">Gitee</a>
        </li>
      
        <li class="nav-item">
          <a class="nav-link" href="https://github.com/ABNER-1" target="_blank" rel="noopener">Github</a>
        </li>
      
    </ul>
    <hr class="hidden-md-up" />
  </div>
</nav>


  		<div class="row">
  			<div class="col-12 mb-4">
  <img class="img-fluid project-img" src="/images/unsplash.jpg" alt="fastAPI_debug_async">
</div>
<div class="col-lg-4 col-12 pt-3 px-4 pr-lg-5">
  <h1>fastAPI_debug_async</h1>
</div>
<div class="col-lg-8 col-12 pt-lg-3 mb-4 pl-lg-5 px-lg-0 px-4 portfolio-content">
  <p>最近被求助一个问题：<br>使用 fastAPI 部署 python web 服务时，async 一个AI 推理函数不起作用，导致一个推理请求进来后，后续进来的请求被阻塞了。</p>
<a id="more"></a>

<h3 id="问题分析思路"><a href="#问题分析思路" class="headerlink" title="问题分析思路"></a>问题分析思路</h3><p>官网的异步示例代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.get('/predict')</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">predict</span><span class="params">()</span>:</span></span><br><span class="line">    results = <span class="keyword">await</span> some_pytorch_predict()</span><br><span class="line">    <span class="keyword">return</span> results</span><br></pre></td></tr></table></figure>

<p>此时观察现象： 请求进来时 CPU 瞬间拉满，因为 pytorch 后端是通过 Cython 调用的 C++，所以可以突破 python 单进程只能跑满一个核的问题。</p>
<ol>
<li><p>首先考虑是代码的问题。<br>因为 fastAPI async 的特性，有些函数就是无法被打断，比如 time.sleep(1), 换成 asyncio.sleep 即可实现 async 的功能。 <a href="https://github.com/tiangolo/fastapi/issues/958" target="_blank" rel="noopener">github issue</a></p>
</li>
<li><p>此时考虑到第三方库，尤其是这种 pytorch 后端实现都是跨 c++ 的，可能真的不被打断。<br> 还有一种情况就是此时 CPU 已经被跑满了，导致新的请求即使进来也不会被执行到。考虑限制 pytorch 最大 cpu 占用，但此时还是能跑满一个核，且此时还是不能被打断。</p>
</li>
<li><p>既然代码层面解决不了，那有没有可能从部署层面考虑？</p>
<p> 使用 gunicorn 启动该服务，设置多个 worker，即使一个worker 跑满那个进程，此时一个同等优先级的 worker 进程去和它竞争还是可以抢到资源的。</p>
<p> 此时的确解决了该问题。但因为 gunicorn 启动造成了pytorch 有多份，既造成了大量的资源浪费，也无法服务超过 worker 数的请求：即同时有 worker 数的推理请求进来，所有 worker 进程还是会跑满 worker，使得低计算消耗的请求会阻塞很久。</p>
</li>
<li><p>有没有更好的方法去优雅地解决呢？<br>最后的解决方案是使用 multiThread 去包装一下第三方无法被打断的 AI 推理函数。这种方案完美的解决了这个问题。</p>
<p>其实 python 里面的 multiThread 一直被调侃，毕竟一个python 进程，即使开再多线程也只能去分一个核的计算时间片，不能很显著提高效率，平时使用也会用 multiProcess 去起多个字进程占用多个核的资源来提高资源利用率。但是这类 thread_pool 类代码，肯定是要实现调度的，也就是被打断是从根本上支持的，用其来包装一个不可被打断的函数，简直绝配。</p>
</li>
</ol>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>   这次的问题其实本质上还是因为架构设计不合理导致的，后来的解决方案也只是目前的系统最简单也最优雅的一种解决方案。关键的这类的问题最后还是落在无状态服务调用计算密集型组件下如何保证服务的高可用的问题。</p>

</div>


      </div>
      
  	</div>

    <!-- After footer scripts -->
    <script src="https://code.jquery.com/jquery-3.1.1.slim.min.js" integrity="sha384-A7FZj7v+d/sdmMqp/nOQwliLvUsJfDHW+k9Omg/a/EheAdgtzNs3hpfag6Ed950n" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/tether/1.4.0/js/tether.min.js" integrity="sha384-DztdAPBWPRXSA/3eYEEUWrWCy7G5KFbe8fFjk5JAIxUYHKkDx6Qin1DkWx51bBrb" crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/js/bootstrap.min.js" integrity="sha384-vBWWzlZJ8ea9aCX4pEW3rVHjgjt7zpkNpZk+02D9phzyeVkE+jo0ieGizqPLForn" crossorigin="anonymous"></script>

  </body>
</html>
